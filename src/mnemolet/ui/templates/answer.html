{% extends "base.html" %}

{% block title %}Answer - MnemoLet{% endblock%}

{% block content %}
    <h2 class="text-3xl font-bold mb-4 text-gray-800">Generated Answer</h2>

    <form id="query-form" class="mb-6">
    <input
        type="text"
        id="query"
        name="query"
        placeholder="Enter your question..."
        class="border border-gray-300 rounded px-4 py-2 w-full max-w-lg"
        required
    />
    <button
        type="submit"
        class="ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
        Search
    </button>
    </form>

    <div id="answer" class="bg-white rounded shadow p-6 text-gray-700
             whitespace-pre-wrap min-h-[120px]"></div>
    <ul id="sources" class="bg-gray-50 rounded shadow p-6 mt-4 space-y-2"></ul>

<script>
const form = document.getElementById('query-form');
const queryInput = document.getElementById('query');
const answerEl = document.getElementById('answer');
const sourcesEl = document.getElementById('sources');
const submitBtn = form.querySelector('button');

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = queryInput.value.trim();
    if (!query) return;

    // clear previous content
    answerEl.textContent = '';
    sourcesEl.innerHTML = '';
    sourcesEl.style.display = 'none';

    submitBtn.disabled = true;

    const response = await fetch(`/api/answer?query=${encodeURIComponent(query)}`);
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        let lines = buffer.split(/r?\n/);
        buffer = lines.pop();

        for (const line of lines) {
            if (!line.trim()) continue; // skip empty lines
        
            try {
                const event = JSON.parse(line.trim());

                if (event.type === 'chunk') {
                    answerEl.textContent += event.data;
                }
                
                if (event.type === 'sources') {
                    sourcesEl.style.display = 'block';
                    sourcesEl.innerHTML = '<h3 class="font-semibold mb-2">Sources:</h3>' + 
                        '<ul class="list-disc pl-6">' + 
                        event.data.map((s, i) => `<li>${i + 1}. ${s.path || 'Source'}</li>`).join('') +
                        '</ul>';
                }

                if (event.type === 'error') {
                    answerEl.textContent += `\n[Error]: ${event.data}`
                }
            } catch (err) {
                console.error('JSON parse error:', err)
                console.error('Failing line:', line)
                answerEl.textContent += line;
            }
        }
    }
    submitBtn.disabled = false;
});
</script>
{% endblock %}
